<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cluj Bus App - Nearby Station Debug Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .data-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        
        .json-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .metric {
            display: inline-block;
            background: #e9ecef;
            padding: 8px 12px;
            margin: 4px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .metric.good { background: #d4edda; color: #155724; }
        .metric.bad { background: #f8d7da; color: #721c24; }
        .metric.warning { background: #fff3cd; color: #856404; }
        
        h1 { color: #2c3e50; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        h3 { color: #7f8c8d; }
        
        .step {
            counter-increment: step-counter;
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .step::before {
            content: "Step " counter(step-counter) ": ";
            font-weight: bold;
            color: #007bff;
        }
        .steps { counter-reset: step-counter; }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üöå Cluj Bus App - Nearby Station Debug Tool</h1>
    
    <div class="container">
        <h2>Quick Diagnosis</h2>
        <button onclick="runFullDiagnosis()">üîç Run Full Diagnosis</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        <div id="quickStatus"></div>
    </div>

    <div class="container">
        <h2>Configuration Check</h2>
        <div class="steps">
            <div class="step">
                <h3>Local Storage Data</h3>
                <button onclick="checkLocalStorage()">Check Configuration</button>
                <div id="configResults"></div>
            </div>
            
            <div class="step">
                <h3>API Key Validation</h3>
                <button onclick="validateApiKey()" id="validateBtn">Validate API Key</button>
                <div id="apiResults"></div>
            </div>
            
            <div class="step">
                <h3>Location Services</h3>
                <button onclick="checkLocation()">Check Location</button>
                <div id="locationResults"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Data Fetching Tests</h2>
        <div class="steps">
            <div class="step">
                <h3>Fetch Stations</h3>
                <button onclick="fetchStations()" id="stationsBtn">Fetch Stations</button>
                <div id="stationsResults"></div>
            </div>
            
            <div class="step">
                <h3>Fetch Vehicles</h3>
                <button onclick="fetchVehicles()" id="vehiclesBtn">Fetch Vehicles</button>
                <div id="vehiclesResults"></div>
            </div>
            
            <div class="step">
                <h3>Fetch Routes</h3>
                <button onclick="fetchRoutes()" id="routesBtn">Fetch Routes</button>
                <div id="routesResults"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Network Monitoring</h2>
        <button onclick="startNetworkMonitoring()" id="networkBtn">Start Network Monitoring</button>
        <button onclick="stopNetworkMonitoring()" id="stopNetworkBtn" disabled>Stop Monitoring</button>
        <div id="networkResults"></div>
    </div>

    <div class="container">
        <h2>Manual API Testing</h2>
        <div>
            <label>API Key: <input type="password" id="manualApiKey" placeholder="Enter API key to test"></label>
            <button onclick="testManualApiKey()">Test API Key</button>
        </div>
        <div>
            <label>Agency ID: <input type="number" id="manualAgencyId" placeholder="Enter agency ID"></label>
            <button onclick="testManualAgency()">Test Agency</button>
        </div>
        <div id="manualResults"></div>
    </div>

    <script>
        let networkMonitoring = false;
        let originalFetch = null;
        let networkRequests = [];
        
        // Configuration data
        let appConfig = null;
        let locationData = null;
        
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showData(elementId, title, data, type = 'info') {
            const element = document.getElementById(elementId);
            const jsonStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            element.innerHTML = `
                <div class="status ${type}">${title}</div>
                <div class="json-display">${jsonStr}</div>
            `;
        }
        
        function showMetrics(elementId, metrics) {
            const element = document.getElementById(elementId);
            const metricsHtml = Object.entries(metrics).map(([key, value]) => {
                const type = value === 0 ? 'bad' : value > 0 ? 'good' : 'warning';
                return `<span class="metric ${type}">${key}: ${value}</span>`;
            }).join('');
            element.innerHTML = metricsHtml;
        }
        
        async function runFullDiagnosis() {
            showStatus('quickStatus', 'üîÑ Running full diagnosis...', 'info');
            
            try {
                // Run all checks
                await checkLocalStorage();
                await new Promise(resolve => setTimeout(resolve, 500));
                await validateApiKey();
                await new Promise(resolve => setTimeout(resolve, 500));
                await checkLocation();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (appConfig && appConfig.agencyId && appConfig.apiKey) {
                    await fetchStations();
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await fetchVehicles();
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await fetchRoutes();
                }
                
                showStatus('quickStatus', '‚úÖ Full diagnosis completed! Check results below.', 'success');
            } catch (error) {
                showStatus('quickStatus', `‚ùå Diagnosis failed: ${error.message}`, 'error');
            }
        }
        
        function clearResults() {
            const resultElements = [
                'quickStatus', 'configResults', 'apiResults', 'locationResults',
                'stationsResults', 'vehiclesResults', 'routesResults', 'networkResults', 'manualResults'
            ];
            resultElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '';
            });
            networkRequests = [];
        }
        
        async function checkLocalStorage() {
            try {
                // First, let's see ALL localStorage keys
                const allKeys = Object.keys(localStorage);
                console.log('All localStorage keys:', allKeys);
                
                // Check config store (correct key: 'config')
                const configStore = localStorage.getItem('config');
                const agencyStore = localStorage.getItem('bus-tracker-agencies');
                // Note: Location store doesn't persist to localStorage
                
                let configData = null;
                let agencyData = null;
                
                if (configStore) {
                    configData = JSON.parse(configStore);
                    appConfig = configData.state?.config;
                    console.log('Config data found:', configData);
                }
                
                if (agencyStore) {
                    agencyData = JSON.parse(agencyStore);
                    console.log('Agency data found:', agencyData);
                }
                
                const summary = {
                    'All localStorage keys': allKeys.length > 0 ? `‚úÖ ${allKeys.join(', ')}` : '‚ùå No keys found',
                    'Config Store': configStore ? '‚úÖ Found' : '‚ùå Missing',
                    'API Key': appConfig?.apiKey ? '‚úÖ Set (encrypted)' : '‚ùå Missing',
                    'Agency ID': appConfig?.agencyId ? `‚úÖ ${appConfig.agencyId}` : '‚ùå Missing',
                    'City': appConfig?.city || '‚ùå Not set',
                    'Refresh Rate': appConfig?.refreshRate ? `‚úÖ ${appConfig.refreshRate}ms` : '‚ùå Not set',
                    'Agency Store': agencyStore ? '‚úÖ Found' : '‚ùå Missing',
                    'Cached Agencies': agencyData?.agencies?.length ? `‚úÖ ${agencyData.agencies.length} agencies` : '‚ùå No agencies cached',
                    'API Validated': agencyData?.isApiValidated ? '‚úÖ Yes' : '‚ùå No',
                    'Location Store': '‚ö†Ô∏è Not persisted (runtime only)'
                };
                
                showData('configResults', 'Configuration Summary', summary, 'success');
                
                // Store for later use
                window.debugConfig = { configData, agencyData };
                
            } catch (error) {
                showStatus('configResults', `‚ùå Error checking localStorage: ${error.message}`, 'error');
            }
        }
        
        async function validateApiKey() {
            if (!appConfig?.apiKey) {
                showStatus('apiResults', '‚ùå No API key found. Run configuration check first.', 'error');
                return;
            }
            
            const btn = document.getElementById('validateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Validating...';
            
            try {
                const response = await fetch('/api/tranzy/agencies', {
                    headers: {
                        'Authorization': `Bearer ${appConfig.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const agencies = await response.json();
                    showData('apiResults', `‚úÖ API Key Valid - Found ${agencies.length} agencies`, agencies.slice(0, 3), 'success');
                } else {
                    showStatus('apiResults', `‚ùå API Key Invalid - Status: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('apiResults', `‚ùå API validation failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Validate API Key';
            }
        }
        
        async function checkLocation() {
            try {
                const locationData = window.debugConfig?.locationData?.state;
                const configData = appConfig;
                
                const locationSummary = {
                    'GPS Permission': 'Checking...',
                    'Current Location': locationData?.currentLocation ? 
                        `${locationData.currentLocation.latitude.toFixed(4)}, ${locationData.currentLocation.longitude.toFixed(4)}` : 
                        'Not available',
                    'Home Location': locationData?.homeLocation ? 
                        `${locationData.homeLocation.latitude.toFixed(4)}, ${locationData.homeLocation.longitude.toFixed(4)}` : 
                        'Not set',
                    'Work Location': locationData?.workLocation ? 
                        `${locationData.workLocation.latitude.toFixed(4)}, ${locationData.workLocation.longitude.toFixed(4)}` : 
                        'Not set',
                    'Default Location': configData?.defaultLocation ? 
                        `${configData.defaultLocation.latitude.toFixed(4)}, ${configData.defaultLocation.longitude.toFixed(4)}` : 
                        'Not set'
                };
                
                // Check GPS permission
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            locationSummary['GPS Permission'] = '‚úÖ Granted';
                            locationSummary['Live GPS'] = `${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                            showData('locationResults', 'Location Summary', locationSummary, 'success');
                        },
                        (error) => {
                            locationSummary['GPS Permission'] = `‚ùå ${error.message}`;
                            showData('locationResults', 'Location Summary', locationSummary, 'warning');
                        }
                    );
                } else {
                    locationSummary['GPS Permission'] = '‚ùå Not supported';
                    showData('locationResults', 'Location Summary', locationSummary, 'error');
                }
                
            } catch (error) {
                showStatus('locationResults', `‚ùå Error checking location: ${error.message}`, 'error');
            }
        }
        
        async function fetchStations() {
            if (!appConfig?.apiKey || !appConfig?.agencyId) {
                showStatus('stationsResults', '‚ùå API key or agency ID missing', 'error');
                return;
            }
            
            const btn = document.getElementById('stationsBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Fetching...';
            
            try {
                const response = await fetch(`/api/tranzy/stops?agency_id=${appConfig.agencyId}`, {
                    headers: {
                        'Authorization': `Bearer ${appConfig.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const stations = await response.json();
                    const metrics = {
                        'Total Stations': stations.length,
                        'With Coordinates': stations.filter(s => s.latitude && s.longitude).length,
                        'Named Stations': stations.filter(s => s.name && s.name.trim()).length
                    };
                    
                    showMetrics('stationsResults', metrics);
                    showData('stationsResults', `‚úÖ Fetched ${stations.length} stations`, stations.slice(0, 5), 'success');
                } else {
                    showStatus('stationsResults', `‚ùå Failed to fetch stations: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('stationsResults', `‚ùå Error fetching stations: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Fetch Stations';
            }
        }
        
        async function fetchVehicles() {
            if (!appConfig?.apiKey || !appConfig?.agencyId) {
                showStatus('vehiclesResults', '‚ùå API key or agency ID missing', 'error');
                return;
            }
            
            const btn = document.getElementById('vehiclesBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Fetching...';
            
            try {
                const response = await fetch(`/api/tranzy/vehicles?agency_id=${appConfig.agencyId}`, {
                    headers: {
                        'Authorization': `Bearer ${appConfig.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const vehicles = await response.json();
                    const metrics = {
                        'Total Vehicles': vehicles.length,
                        'With Position': vehicles.filter(v => v.position?.latitude && v.position?.longitude).length,
                        'With Route': vehicles.filter(v => v.routeId).length,
                        'Active': vehicles.filter(v => v.currentStatus === 'IN_TRANSIT_TO').length
                    };
                    
                    showMetrics('vehiclesResults', metrics);
                    showData('vehiclesResults', `‚úÖ Fetched ${vehicles.length} vehicles`, vehicles.slice(0, 3), 'success');
                } else {
                    showStatus('vehiclesResults', `‚ùå Failed to fetch vehicles: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('vehiclesResults', `‚ùå Error fetching vehicles: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Fetch Vehicles';
            }
        }
        
        async function fetchRoutes() {
            if (!appConfig?.apiKey || !appConfig?.agencyId) {
                showStatus('routesResults', '‚ùå API key or agency ID missing', 'error');
                return;
            }
            
            const btn = document.getElementById('routesBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Fetching...';
            
            try {
                const response = await fetch(`/api/tranzy/routes?agency_id=${appConfig.agencyId}`, {
                    headers: {
                        'Authorization': `Bearer ${appConfig.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const routes = await response.json();
                    const metrics = {
                        'Total Routes': routes.length,
                        'Named Routes': routes.filter(r => r.routeName || r.shortName).length,
                        'With Type': routes.filter(r => r.type).length
                    };
                    
                    showMetrics('routesResults', metrics);
                    showData('routesResults', `‚úÖ Fetched ${routes.length} routes`, routes.slice(0, 5), 'success');
                } else {
                    showStatus('routesResults', `‚ùå Failed to fetch routes: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('routesResults', `‚ùå Error fetching routes: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Fetch Routes';
            }
        }
        
        function startNetworkMonitoring() {
            if (networkMonitoring) return;
            
            networkMonitoring = true;
            networkRequests = [];
            
            // Override fetch
            originalFetch = window.fetch;
            window.fetch = function(...args) {
                const startTime = Date.now();
                const url = args[0];
                
                console.log('üåê FETCH REQUEST:', url);
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        const endTime = Date.now();
                        const duration = endTime - startTime;
                        
                        const requestInfo = {
                            url,
                            method: args[1]?.method || 'GET',
                            status: response.status,
                            ok: response.ok,
                            duration,
                            timestamp: new Date().toLocaleTimeString()
                        };
                        
                        networkRequests.push(requestInfo);
                        updateNetworkDisplay();
                        
                        console.log('üåê FETCH RESPONSE:', url, response.status, `${duration}ms`);
                        return response;
                    })
                    .catch(error => {
                        const endTime = Date.now();
                        const duration = endTime - startTime;
                        
                        const requestInfo = {
                            url,
                            method: args[1]?.method || 'GET',
                            status: 'ERROR',
                            ok: false,
                            duration,
                            error: error.message,
                            timestamp: new Date().toLocaleTimeString()
                        };
                        
                        networkRequests.push(requestInfo);
                        updateNetworkDisplay();
                        
                        console.log('üåê FETCH ERROR:', url, error);
                        throw error;
                    });
            };
            
            document.getElementById('networkBtn').disabled = true;
            document.getElementById('stopNetworkBtn').disabled = false;
            
            showStatus('networkResults', 'üîÑ Network monitoring started. Make some requests to see activity.', 'info');
        }
        
        function stopNetworkMonitoring() {
            if (!networkMonitoring) return;
            
            networkMonitoring = false;
            
            // Restore original fetch
            if (originalFetch) {
                window.fetch = originalFetch;
                originalFetch = null;
            }
            
            document.getElementById('networkBtn').disabled = false;
            document.getElementById('stopNetworkBtn').disabled = true;
            
            showStatus('networkResults', '‚èπÔ∏è Network monitoring stopped.', 'info');
        }
        
        function updateNetworkDisplay() {
            const recent = networkRequests.slice(-10);
            const summary = {
                'Total Requests': networkRequests.length,
                'Successful': networkRequests.filter(r => r.ok).length,
                'Failed': networkRequests.filter(r => !r.ok).length,
                'Avg Duration': networkRequests.length > 0 ? 
                    Math.round(networkRequests.reduce((sum, r) => sum + r.duration, 0) / networkRequests.length) + 'ms' : 
                    '0ms'
            };
            
            showData('networkResults', 'Network Activity (Last 10 requests)', { summary, recent }, 'info');
        }
        
        async function testManualApiKey() {
            const apiKey = document.getElementById('manualApiKey').value.trim();
            if (!apiKey) {
                showStatus('manualResults', '‚ùå Please enter an API key', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/tranzy/agencies', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const agencies = await response.json();
                    showData('manualResults', `‚úÖ Manual API Key Test Successful - ${agencies.length} agencies`, agencies, 'success');
                } else {
                    showStatus('manualResults', `‚ùå Manual API Key Test Failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('manualResults', `‚ùå Manual API Key Test Error: ${error.message}`, 'error');
            }
        }
        
        async function testManualAgency() {
            const agencyId = document.getElementById('manualAgencyId').value.trim();
            const apiKey = document.getElementById('manualApiKey').value.trim();
            
            if (!apiKey || !agencyId) {
                showStatus('manualResults', '‚ùå Please enter both API key and agency ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/tranzy/stops?agency_id=${agencyId}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const stops = await response.json();
                    showData('manualResults', `‚úÖ Manual Agency Test Successful - ${stops.length} stops`, stops.slice(0, 5), 'success');
                } else {
                    showStatus('manualResults', `‚ùå Manual Agency Test Failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('manualResults', `‚ùå Manual Agency Test Error: ${error.message}`, 'error');
            }
        }
        
        // Auto-load configuration on page load
        window.addEventListener('load', () => {
            checkLocalStorage();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (networkMonitoring) {
                stopNetworkMonitoring();
            }
        });
    </script>
</body>
</html>